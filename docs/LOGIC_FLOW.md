# 系统逻辑架构与数据流图

## 1. 整体逻辑架构图

```
┌──────────────────────────────────────────────────────────────────────┐
│                            用户层 (User Layer)                         │
│                                                                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐│
│  │  Web浏览器   │  │   MetaMask  │  │  WalletConnect│ │  手机钱包   ││
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘│
└─────────────────────────────┬────────────────────────────────────────┘
                              │
                              │ HTTPS / WebSocket / Web3
                              │
┌─────────────────────────────▼────────────────────────────────────────┐
│                        前端应用层 (Frontend Layer)                      │
│                                                                        │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                      React Application                         │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌─────────┐│  │
│  │  │  UI Layer  │  │   Hooks    │  │  Services  │  │  Utils  ││  │
│  │  └────────────┘  └────────────┘  └────────────┘  └─────────┘│  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                        │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                   State Management (React Query)               │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────┬──────────────────────┬──────────────────┬──────────────────┘
          │                      │                  │
          │                      │                  │
    ┌─────▼──────┐      ┌───────▼───────┐     ┌───▼──────────┐
    │  Web3.js/  │      │   REST API     │     │  WebSocket   │
    │  Ethers.js │      │   Client       │     │   Client     │
    └─────┬──────┘      └───────┬───────┘     └───┬──────────┘
          │                     │                  │
          │                     │                  │
┌─────────▼─────────────────────▼──────────────────▼──────────────────┐
│                      中间层 (Middleware Layer)                        │
│                                                                        │
│  ┌───────────────┐  ┌────────────────┐  ┌─────────────────────┐    │
│  │   API Gateway │  │  WebSocket     │  │   Data Aggregator   │    │
│  │   (BFF)       │  │  Server        │  │   Service           │    │
│  └───────────────┘  └────────────────┘  └─────────────────────┘    │
└─────────┬──────────────────┬─────────────────────┬──────────────────┘
          │                  │                     │
          │                  │                     │
    ┌─────▼──────┐    ┌─────▼──────┐      ┌──────▼────────┐
    │ Polymarket │    │  Gemini    │      │   Polygon     │
    │ CLOB API   │    │  AI API    │      │   Network     │
    └─────┬──────┘    └─────┬──────┘      └──────┬────────┘
          │                 │                     │
┌─────────▼─────────────────▼─────────────────────▼──────────────────┐
│                      数据层 (Data Layer)                              │
│                                                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────────────┐  │
│  │  Polymarket  │  │  Google AI   │  │  Blockchain (Polygon)   │  │
│  │  Trading Data│  │  Model       │  │  Smart Contracts        │  │
│  └──────────────┘  └──────────────┘  └─────────────────────────┘  │
└────────────────────────────────────────────────────────────────────┘
```

## 2. 核心业务流程

### 2.1 赛事创建流程

```
┌──────┐         ┌──────────┐         ┌────────────┐         ┌──────────┐
│ 管理员│         │  前端    │         │  智能合约   │         │ 后端服务  │
└──┬───┘         └────┬─────┘         └─────┬──────┘         └────┬─────┘
   │                  │                     │                      │
   │ 1. 创建赛事       │                     │                      │
   │─────────────────>│                     │                      │
   │                  │                     │                      │
   │                  │ 2. 调用createRace() │                      │
   │                  │────────────────────>│                      │
   │                  │                     │                      │
   │                  │                     │ 3. 验证参数          │
   │                  │                     │──────┐              │
   │                  │                     │      │              │
   │                  │                     │<─────┘              │
   │                  │                     │                      │
   │                  │                     │ 4. 创建Race记录      │
   │                  │                     │──────┐              │
   │                  │                     │      │              │
   │                  │                     │<─────┘              │
   │                  │                     │                      │
   │                  │                     │ 5. 触发RaceCreated事件│
   │                  │                     │─────────────────────>│
   │                  │                     │                      │
   │                  │ 6. 返回交易成功      │                      │
   │                  │<────────────────────│                      │
   │                  │                     │                      │
   │                  │                     │           7. 监听事件 │
   │                  │                     │<─────────────────────│
   │                  │                     │                      │
   │                  │                     │           8. 初始化赛事│
   │                  │                     │           订阅数据流  │
   │                  │                     │           <─────┐   │
   │                  │                     │                 │   │
   │                  │                     │           ──────┘   │
   │                  │                     │                      │
   │                  │<────────────────────┼──────────────────────│
   │ 9. 显示赛事信息   │        9. 推送赛事数据                       │
   │<─────────────────│                     │                      │
```

### 2.2 用户下注流程

```
┌──────┐     ┌──────────┐     ┌──────────┐     ┌────────────┐     ┌──────────┐
│ 用户  │     │  前端     │     │  钱包     │     │  智能合约   │     │ AI服务   │
└──┬───┘     └────┬─────┘     └────┬─────┘     └─────┬──────┘     └────┬─────┘
   │              │                │                 │                  │
   │ 1. 点击Boost │                │                 │                  │
   │─────────────>│                │                 │                  │
   │              │                │                 │                  │
   │              │ 2. 请求签名    │                 │                  │
   │              │───────────────>│                 │                  │
   │              │                │                 │                  │
   │              │                │ 3. 用户授权     │                  │
   │              │                │────┐            │                  │
   │              │                │    │            │                  │
   │              │                │<───┘            │                  │
   │              │                │                 │                  │
   │              │ 4. 签名结果    │                 │                  │
   │              │<───────────────│                 │                  │
   │              │                │                 │                  │
   │              │ 5. 调用placeBet(raceId, choice, amount)            │
   │              │────────────────┼────────────────>│                  │
   │              │                │                 │                  │
   │              │                │                 │ 6. 验证条件       │
   │              │                │                 │   - 赛事进行中   │
   │              │                │                 │   - 金额合法     │
   │              │                │                 │   - 未重复下注   │
   │              │                │                 │──────┐           │
   │              │                │                 │      │           │
   │              │                │                 │<─────┘           │
   │              │                │                 │                  │
   │              │                │                 │ 7. 转账ETH到合约 │
   │              │                │                 │──────┐           │
   │              │                │                 │      │           │
   │              │                │                 │<─────┘           │
   │              │                │                 │                  │
   │              │                │                 │ 8. 记录用户下注  │
   │              │                │                 │──────┐           │
   │              │                │                 │      │           │
   │              │                │                 │<─────┘           │
   │              │                │                 │                  │
   │              │                │                 │ 9. 触发BetPlaced │
   │              │                │                 │─────────────────>│
   │              │                │                 │                  │
   │              │ 10. 交易成功   │                 │      10. 接收事件│
   │              │<────────────────────────────────│      <────┐      │
   │              │                │                 │           │      │
   │              │                │                 │      ─────┘      │
   │              │                │                 │                  │
   │              │ 11. 发送新数据给AI                │                  │
   │              │─────────────────────────────────┼─────────────────>│
   │              │                │                 │                  │
   │              │                │                 │      12. 重新分析│
   │              │                │                 │      预测概率    │
   │              │                │                 │      <─────┐    │
   │              │                │                 │            │    │
   │              │                │                 │      ──────┘    │
   │              │                │                 │                  │
   │              │ 13. 返回新预测  │                 │                  │
   │              │<─────────────────────────────────┼──────────────────│
   │              │                │                 │                  │
   │ 14. 更新UI   │                │                 │                  │
   │   - 赔率     │                │                 │                  │
   │   - 位置     │                │                 │                  │
   │   - 解说     │                │                 │                  │
   │<─────────────│                │                 │                  │
```

### 2.3 实时数据更新流程

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌─────────┐
│Polymarket│    │ WebSocket│    │  前端     │    │ AI服务   │    │  用户   │
└────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬────┘
     │               │               │               │               │
     │ 1. 市场交易   │               │               │               │
     │──────┐        │               │               │               │
     │      │        │               │               │               │
     │<─────┘        │               │               │               │
     │               │               │               │               │
     │ 2. 推送事件   │               │               │               │
     │──────────────>│               │               │               │
     │               │               │               │               │
     │               │ 3. 转发到前端 │               │               │
     │               │──────────────>│               │               │
     │               │               │               │               │
     │               │               │ 4. 解析数据   │               │
     │               │               │──────┐        │               │
     │               │               │      │        │               │
     │               │               │<─────┘        │               │
     │               │               │               │               │
     │               │               │ 5. 发送给AI   │               │
     │               │               │──────────────>│               │
     │               │               │               │               │
     │               │               │               │ 6. 分析预测   │
     │               │               │               │──────┐        │
     │               │               │               │      │        │
     │               │               │               │<─────┘        │
     │               │               │               │               │
     │               │               │ 7. 返回结果   │               │
     │               │               │   - 胜率      │               │
     │               │               │   - 解说      │               │
     │               │               │<──────────────│               │
     │               │               │               │               │
     │               │               │ 8. 更新状态   │               │
     │               │               │   - 位置      │               │
     │               │               │   - 赔率      │               │
     │               │               │   - 动画      │               │
     │               │               │──────┐        │               │
     │               │               │      │        │               │
     │               │               │<─────┘        │               │
     │               │               │               │               │
     │               │               │ 9. 渲染UI     │               │
     │               │               │──────────────────────────────>│
     │               │               │               │               │
     │               │               │               │    10. 查看更新│
     │               │               │               │    <─────┐   │
     │               │               │               │          │   │
     │               │               │               │    ──────┘   │
     │               │               │               │               │
     │<──────────────┼───────────────┼───────────────┼───────────────│
     │  (循环：每2-5秒推送一次新数据)                                  │
```

### 2.4 赛事结算流程

```
┌──────────┐    ┌──────────┐    ┌────────────┐    ┌──────────┐    ┌─────────┐
│ 时间服务 │    │ 后端服务  │    │  智能合约   │    │  前端     │    │  用户   │
└────┬─────┘    └────┬─────┘    └─────┬──────┘    └────┬─────┘    └────┬────┘
     │               │                 │                │               │
     │ 1. 赛事时间到 │                 │                │               │
     │──────┐        │                 │                │               │
     │      │        │                 │                │               │
     │<─────┘        │                 │                │               │
     │               │                 │                │               │
     │ 2. 触发结算   │                 │                │               │
     │──────────────>│                 │                │               │
     │               │                 │                │               │
     │               │ 3. 查询最终价格 │                │               │
     │               │   - Token1价格  │                │               │
     │               │   - Token2价格  │                │               │
     │               │──────┐          │                │               │
     │               │      │          │                │               │
     │               │<─────┘          │                │               │
     │               │                 │                │               │
     │               │ 4. 计算涨跌幅   │                │               │
     │               │   - Token1: +5% │                │               │
     │               │   - Token2: +3% │                │               │
     │               │   Winner: Token1│                │               │
     │               │──────┐          │                │               │
     │               │      │          │                │               │
     │               │<─────┘          │                │               │
     │               │                 │                │               │
     │               │ 5. 调用settleRace(raceId, winner=1)             │
     │               │────────────────>│                │               │
     │               │                 │                │               │
     │               │                 │ 6. 验证权限    │               │
     │               │                 │──────┐         │               │
     │               │                 │      │         │               │
     │               │                 │<─────┘         │               │
     │               │                 │                │               │
     │               │                 │ 7. 记录结果    │               │
     │               │                 │   - winner: 1  │               │
     │               │                 │   - settled: true              │
     │               │                 │──────┐         │               │
     │               │                 │      │         │               │
     │               │                 │<─────┘         │               │
     │               │                 │                │               │
     │               │                 │ 8. 触发RaceSettled事件         │
     │               │                 │───────────────>│               │
     │               │                 │                │               │
     │               │ 9. 返回成功     │                │ 10. 监听事件  │
     │               │<────────────────│                │<──────┐       │
     │               │                 │                │       │       │
     │               │                 │                │───────┘       │
     │               │                 │                │               │
     │               │                 │                │ 11. 显示结果  │
     │               │                 │                │──────────────>│
     │               │                 │                │               │
     │               │                 │                │    12. 领取奖励│
     │               │                 │                │    请求       │
     │               │                 │                │<──────────────│
     │               │                 │                │               │
     │               │                 │ 13. claimReward(raceId)        │
     │               │                 │<───────────────│               │
     │               │                 │                │               │
     │               │                 │ 14. 验证       │               │
     │               │                 │   - 赛事已结算 │               │
     │               │                 │   - 用户下注正确               │
     │               │                 │   - 未领取过   │               │
     │               │                 │──────┐         │               │
     │               │                 │      │         │               │
     │               │                 │<─────┘         │               │
     │               │                 │                │               │
     │               │                 │ 15. 计算奖励   │               │
     │               │                 │   reward =     │               │
     │               │                 │   (bet/totalWin)               │
     │               │                 │   * pool * 0.95│               │
     │               │                 │──────┐         │               │
     │               │                 │      │         │               │
     │               │                 │<─────┘         │               │
     │               │                 │                │               │
     │               │                 │ 16. 转账       │               │
     │               │                 │──────┐         │               │
     │               │                 │      │         │               │
     │               │                 │<─────┘         │               │
     │               │                 │                │               │
     │               │                 │ 17. 返回交易   │               │
     │               │                 │───────────────>│               │
     │               │                 │                │               │
     │               │                 │                │ 18. 确认收款  │
     │               │                 │                │──────────────>│
```

## 3. AI分析流程详解

```
┌─────────────────────────────────────────────────────────────────────┐
│                        AI分析引擎流程                                  │
└─────────────────────────────────────────────────────────────────────┘

输入数据
   │
   ├─ 实时交易数据
   │  ├─ 价格变动
   │  ├─ 交易量
   │  ├─ 买卖方向
   │  └─ 订单深度
   │
   ├─ 用户下注数据
   │  ├─ 下注分布
   │  ├─ 下注趋势
   │  └─ 大户行为
   │
   └─ 历史数据
      ├─ 过去1小时数据
      ├─ 相似场景
      └─ 历史胜率

      ↓

┌─────────────────────┐
│   数据预处理模块     │
│                     │
│  - 数据清洗         │
│  - 特征提取         │
│  - 归一化           │
│  - 时间窗口处理      │
└──────────┬──────────┘
           │
           ↓

┌─────────────────────┐
│   Gemini AI模型     │
│                     │
│  Prompt构建:        │
│  ┌────────────────┐│
│  │你是加密货币专家││
│  │根据以下数据:   ││
│  │- BTC数据...    ││
│  │- ETH数据...    ││
│  │- 下注情况...   ││
│  │预测谁会赢      ││
│  └────────────────┘│
└──────────┬──────────┘
           │
           ↓

┌─────────────────────┐
│   模型推理          │
│                     │
│  - 特征分析         │
│  - 趋势判断         │
│  - 概率计算         │
│  - 解说生成         │
└──────────┬──────────┘
           │
           ↓

┌─────────────────────┐
│   后处理模块        │
│                     │
│  - 解析响应         │
│  - 提取胜率         │
│  - 格式化解说       │
│  - 置信度评估       │
└──────────┬──────────┘
           │
           ↓

输出结果
   │
   ├─ 胜率预测
   │  ├─ Token1: 58%
   │  └─ Token2: 42%
   │
   ├─ 解说文本
   │  └─ "🚀 BTC买盘强劲..."
   │
   └─ 置信度
      └─ 85%
```

## 4. 智能合约状态机

```
┌─────────────────────────────────────────────────────────────────┐
│                      赛事状态转换图                               │
└─────────────────────────────────────────────────────────────────┘

                    createRace()
                         │
                         ▼
                 ┌───────────────┐
                 │   PENDING     │  准备中
                 │  (startTime   │
                 │   未到)       │
                 └───────┬───────┘
                         │
                block.timestamp >= startTime
                         │
                         ▼
                 ┌───────────────┐
            ┌───>│   ACTIVE      │  进行中
            │    │  (可下注)     │
            │    └───────┬───────┘
            │            │
   newBet() │            │ block.timestamp >= endTime
            │            │
            │            ▼
            │    ┌───────────────┐
            │    │   ENDED       │  已结束
            │    │  (等待结算)   │  (不可下注)
            │    └───────┬───────┘
            │            │
            │            │ settleRace()
            │            │
            │            ▼
            │    ┌───────────────┐
            │    │   SETTLED     │  已结算
            │    │  (可领取奖励) │
            │    └───────┬───────┘
            │            │
            │            │ 所有用户claimReward()
            │            │
            │            ▼
            │    ┌───────────────┐
            └────│   COMPLETED   │  已完成
                 │  (已分发奖励) │
                 └───────────────┘


┌─────────────────────────────────────────────────────────────────┐
│                      用户状态转换图                               │
└─────────────────────────────────────────────────────────────────┘

                         │
                         ▼
                 ┌───────────────┐
                 │   NO_BET      │  未下注
                 └───────┬───────┘
                         │
                   placeBet()
                         │
                         ▼
                 ┌───────────────┐
                 │   BET_PLACED  │  已下注
                 └───────┬───────┘
                         │
                赛事结算后
                         │
              ┌──────────┴──────────┐
              │                     │
         (猜对)│                     │(猜错)
              ▼                     ▼
      ┌───────────────┐     ┌───────────────┐
      │   WON         │     │   LOST        │
      │  (可领奖)     │     │  (无奖励)     │
      └───────┬───────┘     └───────────────┘
              │
       claimReward()
              │
              ▼
      ┌───────────────┐
      │   CLAIMED     │  已领奖
      └───────────────┘
```

## 5. 数据模型关系图

```
┌──────────────────────────────────────────────────────────────────┐
│                        核心数据模型                                │
└──────────────────────────────────────────────────────────────────┘

┌─────────────────────┐
│      Race           │
├─────────────────────┤
│ id: uint256         │───────┐
│ token1: address     │       │
│ token2: address     │       │
│ startTime: uint256  │       │ 1对多
│ endTime: uint256    │       │
│ totalPool: uint256  │       │
│ winner: uint8       │       │
│ status: RaceStatus  │       │
└─────────────────────┘       │
                              │
                              ▼
                    ┌─────────────────────┐
                    │      Bet            │
                    ├─────────────────────┤
                    │ raceId: uint256     │
                    │ user: address       │
                    │ choice: uint8       │
                    │ amount: uint256     │
                    │ timestamp: uint256  │
                    │ claimed: bool       │
                    └─────────────────────┘
                              │
                              │ 多对1
                              │
                              ▼
                    ┌─────────────────────┐
                    │      User           │
                    ├─────────────────────┤
                    │ address: address    │
                    │ totalBets: uint256  │
                    │ totalWon: uint256   │
                    │ winRate: uint256    │
                    └─────────────────────┘


┌─────────────────────┐         ┌─────────────────────┐
│  PolymarketData     │         │   AIAnalysis        │
├─────────────────────┤         ├─────────────────────┤
│ market: string      │         │ raceId: uint256     │
│ token: address      │────────>│ timestamp: uint256  │
│ price: number       │  输入    │ token1Odds: uint8   │
│ volume: number      │         │ token2Odds: uint8   │
│ trades: Trade[]     │         │ commentary: string  │
│ timestamp: uint256  │         │ confidence: uint8   │
└─────────────────────┘         └─────────────────────┘
```

## 6. 安全机制流程图

```
┌──────────────────────────────────────────────────────────────────┐
│                       防作恶检查流程                               │
└──────────────────────────────────────────────────────────────────┘

       用户下注请求
            │
            ↓
    ┌───────────────┐
    │ 检查赛事状态  │
    │ status==ACTIVE?│
    └───┬───────┬───┘
    NO  │       │ YES
        │       ↓
        │   ┌───────────────┐
        │   │ 检查时间窗口  │
        │   │ timestamp < end?│
        │   └───┬───────┬───┘
        │   NO  │       │ YES
        │       │       ↓
        │       │   ┌───────────────┐
        │       │   │ 检查重复下注  │
        │       │   │ !hasBet(user)?│
        │       │   └───┬───────┬───┘
        │       │   NO  │       │ YES
        │       │       │       ↓
        │       │       │   ┌───────────────┐
        │       │       │   │ 检查金额范围  │
        │       │       │   │ amount>=MIN && │
        │       │       │   │ amount<=MAX?  │
        │       │       │   └───┬───────┬───┘
        │       │       │   NO  │       │ YES
        │       │       │       │       ↓
        │       │       │       │   ┌───────────────┐
        │       │       │       │   │ 检查余额充足  │
        │       │       │       │   │ balance>=amount?│
        │       │       │       │   └───┬───────┬───┘
        │       │       │       │   NO  │       │ YES
        │       │       │       │       │       ↓
        │       │       │       │       │   ┌───────────────┐
        │       │       │       │       │   │ 执行下注      │
        │       │       │       │       │   └───────────────┘
        │       │       │       │       │           │
        ▼       ▼       ▼       ▼       ▼           ▼
    ┌───────────────────────────────────┐      下注成功
    │          交易失败并回滚             │
    │      返回相应错误信息              │
    └───────────────────────────────────┘
```

## 7. 系统监控流程

```
┌──────────────────────────────────────────────────────────────────┐
│                       监控与告警系统                               │
└──────────────────────────────────────────────────────────────────┘

   ┌────────────┐      ┌────────────┐      ┌────────────┐
   │ 前端监控   │      │ 合约监控   │      │ API监控    │
   └─────┬──────┘      └─────┬──────┘      └─────┬──────┘
         │                   │                   │
         │                   │                   │
         └───────────────────┼───────────────────┘
                             │
                             ▼
                    ┌────────────────┐
                    │  数据采集层    │
                    │  - 日志收集    │
                    │  - 指标采集    │
                    │  - 事件跟踪    │
                    └────────┬───────┘
                             │
                             ▼
                    ┌────────────────┐
                    │  数据处理层    │
                    │  - 数据清洗    │
                    │  - 聚合计算    │
                    │  - 异常检测    │
                    └────────┬───────┘
                             │
                  ┌──────────┼──────────┐
                  │          │          │
                  ▼          ▼          ▼
         ┌────────────┐ ┌────────────┐ ┌────────────┐
         │ 告警系统   │ │ 可视化展示 │ │ 日志存储   │
         │ - Email    │ │ - Dashboard│ │ - 历史记录 │
         │ - Slack    │ │ - 实时图表 │ │ - 审计追踪 │
         │ - SMS      │ │ - 统计报表 │ │ - 查询分析 │
         └────────────┘ └────────────┘ └────────────┘
```

## 8. 总结

本文档详细描述了PolyRace系统的逻辑架构和各个核心流程：

✅ **整体架构**: 清晰的分层设计，前端、中间层、数据层职责明确  
✅ **业务流程**: 从赛事创建到结算的完整生命周期  
✅ **实时通信**: WebSocket实时数据推送机制  
✅ **AI集成**: 智能分析和预测的完整流程  
✅ **安全机制**: 多层次的验证和防作恶设计  
✅ **监控体系**: 全方位的系统监控和告警

通过这些架构设计，PolyRace实现了一个可靠、安全、实时的预测竞赛平台。
